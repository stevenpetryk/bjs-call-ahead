root = exports ? this

$(document).ready ->
	# Set up jQuery to use text/javascript requests only
	jQuery.ajaxSetup({ 
	  'beforeSend': (xhr) ->
	  	xhr.setRequestHeader("Accept", "application/json")
	})

	# Initialize view
	View.init()

root.View = 
	# Pattern for disclaimer matching
	disclaimerPattern: /\ \[\*\=(.+)\]/

	# Initializes the view in its entirety
	init: ->
		# Initialize viewport height
		@fixInfinityEdges()

		# Load the first category
		# Controller.loadCategory(1)

		# Bind events
		@bindAll()

	# Binds all events
	bindAll: ->
		# Clicking on a favorite star
		$('#menu li .favorite_toggle').live 'click', ->
			itemid = $(this).closest('li').attr('id').split('_')[1]

			Controller.setFavorite(itemid, !$(this).data('checked'))

		# Window resizing
		$(window).resize @fixInfinityEdges

	# Highlights current #category li
	highlightCategory: (id) ->
		$('.category').removeClass('current')
		$('#category_'+id).addClass('current')

	# Resizes certain elements to stay at 100% height as the page height changes
	fixInfinityEdges: ->
		elements = $('#categories, #menu, #order')
		idealHeight = 
			$(window).height() - ( $('#footer').height() + $('#header').height() )
		elements.height( idealHeight )

	# Toggles the given favorite star
	toggleStar: (itemid, toggle) ->
		srcs =
			'true' : '<%= asset_path 'favorited.png' %>'
			'false': '<%= asset_path 'notfavorited.png' %>'

		$('#item_'+itemid).find('.favorite_toggle')
			.data('checked', toggle)

		$('#item_'+itemid).find('.favorite_toggle img')
			.attr('src', srcs[toggle.toString()])

root.Controller = 
	loadCategory: (id) ->
		Model.findCategory id, (data) ->
			View.populateMenu(data)
			View.highlightCategory(id)

	setFavorite: (itemid, toggle) ->
		srcs = {
			'true' : '<%= asset_path 'favorited.png' %>'
			'false': '<%= asset_path 'notfavorited.png' %>'
		}

		if toggle
			Model.addFavorite(itemid)
		else
			Model.removeFavorite(itemid)

		View.toggleStar(itemid, toggle)

root.Model = 
	addFavorite: (id) ->
		$.post '/favorites',
			'item_id': id

	removeFavorite: (id) ->
		$.ajax
        url: '/favorites/'+id,
        type: 'post',
        dataType: 'script',
        data: { '_method': 'delete' }
